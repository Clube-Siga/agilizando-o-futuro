version: "3.8"
# --- ✅ PASSO 1: Declaração de que os segredos já existem no Swarm ---
secrets:
  db_username:
    external: true
  db_password:
    external: true

services:
  # --- Serviço da Aplicação (PHP-FPM) ---
  agilizando-app:
    image: ${APP_IMAGE_TAG:-ghcr.io/clube-siga/agilizando-app:latest}
    environment:
      - TZ=America/Sao_Paulo
    env_file:
      - .env.production
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    volumes:
      - agilizando_storage:/var/www/html/storage
      - ./.env.production:/var/www/html/.env
    networks:
      - staging
    # --- ✅ PASSO 2: Adiciona os segredos ---
    secrets:
      - db_username
      - db_password

  # --- Servidor Web (Nginx) ---
  agilizando-nginx:
    # ✅ IMAGEM CORRETA E DINÂMICA
    image: ${NGINX_IMAGE_TAG:-ghcr.io/clube-siga/agilizando-nginx:latest}
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    volumes:
      - ./docker/nginx/agilizando-production.conf:/etc/nginx/conf.d/default.conf
      - agilizando_storage:/var/www/html/storage
      - agilizando_logs:/var/log/nginx
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.agilizando-prod.rule=Host(`agilizando.clubesiga.com.br`)"
      - "traefik.http.routers.agilizando-prod.entrypoints=websecure"
      - "traefik.http.routers.agilizando-prod.tls.certresolver=leresolver"
      - "traefik.http.services.agilizando-prod.loadbalancer.server.port=80"
    networks:
      - web
      - staging
    depends_on:
      - agilizando-app

# --- Definição dos Volumes e Redes Externas ---
volumes:
  agilizando_logs:
    external: true
  agilizando_storage:
    external: true

networks:
  web:
    external: true
  staging:
    external: true